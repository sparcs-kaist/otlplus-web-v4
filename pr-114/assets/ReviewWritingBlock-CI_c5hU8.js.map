{"version":3,"file":"ReviewWritingBlock-CI_c5hU8.js","sources":["../../../app/common/components/reviews/ReviewWritingBlock.tsx"],"sourcesContent":["import { type Dispatch, type SetStateAction, useEffect, useMemo, useState } from \"react\"\n\nimport styled from \"@emotion/styled\"\nimport { useQueryClient } from \"@tanstack/react-query\"\nimport { useTranslation } from \"react-i18next\"\n\nimport Button from \"@/common/components/Button\"\nimport GradeWrap from \"@/common/components/GradeWrap\"\nimport { ScoreEnum } from \"@/common/enum/scoreEnum\"\nimport { SemesterEnum, semesterToString } from \"@/common/enum/semesterEnum\"\nimport FlexWrapper from \"@/common/primitives/FlexWrapper\"\nimport TextInputArea from \"@/common/primitives/TextInputArea\"\nimport Typography from \"@/common/primitives/Typography\"\nimport type { Professor } from \"@/common/schemas/professor\"\nimport type { Review } from \"@/common/schemas/review\"\nimport { trackEvent } from \"@/libs/mixpanel\"\nimport { useAPI } from \"@/utils/api/useAPI\"\nimport professorName from \"@/utils/professorName\"\nimport useUserStore from \"@/utils/zustand/useUserStore\"\n\nconst ReviewWrapper = styled(FlexWrapper)`\n    padding: 8px 10px;\n    width: 100%;\n    border-radius: 6px;\n    border: 1px ${({ theme }) => theme.colors.Background.Block.dark} solid;\n    background-color: ${({ theme }) => theme.colors.Background.Block.default};\n`\n\nconst ReviewBoxWrapper = styled(FlexWrapper)`\n    height: 160px;\n`\n\nconst GradesWrapper = styled(FlexWrapper)`\n    flex-wrap: wrap;\n`\n\nconst DisabledOverlay = styled(FlexWrapper)<{ blur: boolean }>`\n    width: 100%;\n    height: 100%;\n    filter: ${(props) => (props.blur ? \"blur(4px)\" : \"none\")};\n    pointer-events: ${(props) => (props.blur ? \"none\" : \"auto\")};\n    user-select: ${(props) => (props.blur ? \"none\" : \"auto\")};\n`\n\nconst DisabledMessage = styled(Typography)`\n    position: absolute;\n    padding: 0 20px 0 0;\n    width: 100%;\n    top: 50%;\n    transform: translateY(-50%);\n    text-align: center;\n    z-index: 10;\n`\n\nexport interface ReviewWritingBlockProps {\n    name: string\n    lectureId: number\n    professors: Professor[]\n    year: number\n    semester: SemesterEnum\n}\n\nfunction ReviewWritingBlock({\n    name,\n    lectureId,\n    professors,\n    year,\n    semester,\n}: ReviewWritingBlockProps) {\n    const { t } = useTranslation()\n    const { user, status } = useUserStore()\n    const queryClient = useQueryClient()\n\n    const [myReview, setMyReview] = useState<Review | null>(null)\n\n    const { requestFunction: requestCreateFunction } = useAPI(\"POST\", \"/reviews\", {\n        onSuccess: () => {\n            queryClient.invalidateQueries({ queryKey: [\"/reviews\"] })\n            queryClient.invalidateQueries({\n                queryKey: [`/users/${user?.id}/lectures`],\n            })\n            queryClient.invalidateQueries({\n                queryKey: [\"/users/written-reviews\"],\n            })\n            queryClient.invalidateQueries({\n                queryKey: [\"/users/writable-review\"],\n            })\n        },\n    })\n\n    const { requestFunction: requestEditFunction } = useAPI(\n        \"PUT\",\n        `/reviews/${myReview?.id}`,\n        {\n            onSuccess: () => {\n                queryClient.invalidateQueries({\n                    queryKey: [\"/reviews\"],\n                })\n                queryClient.invalidateQueries({\n                    queryKey: [`/users/${user?.id}/lectures`],\n                })\n                queryClient.invalidateQueries({\n                    queryKey: [\"/users/written-reviews\"],\n                })\n                queryClient.invalidateQueries({\n                    queryKey: [\"/users/writable-review\"],\n                })\n            },\n        },\n    )\n\n    const { query: userReviewsQuery } = useAPI(\"GET\", `/users/written-reviews`, {\n        enabled: status === \"success\",\n    })\n    const { query: semesterQuery } = useAPI(\"GET\", \"/semesters\")\n    const canWriteReview = useMemo(() => {\n        if (!semesterQuery.data) return false\n        const currentSemester = semesterQuery.data.semesters.find(\n            (sem) => sem.year === year && sem.semester === semester,\n        )\n        if (!currentSemester) return false\n        return new Date(currentSemester.courseDropDeadline) < new Date()\n    }, [semesterQuery.data])\n\n    useEffect(() => {\n        if (userReviewsQuery.data) {\n            const existingReview = userReviewsQuery.data.reviews.find(\n                (review) => review.lectureId === lectureId,\n            )\n            if (existingReview) {\n                setMyReview(existingReview)\n            } else {\n                setMyReview(null)\n            }\n        }\n    }, [userReviewsQuery.data, lectureId])\n\n    const [reviewText, setReviewText] = useState<string>(\"\")\n\n    const [reviewGrade, setReviewGrade] = useState<ScoreEnum>(0)\n    const [reviewLoad, setReviewLoad] = useState<ScoreEnum>(0)\n    const [reviewSpeech, setReviewSpeech] = useState<ScoreEnum>(0)\n\n    function resetReviewStates() {\n        setReviewText(\"\")\n        setReviewGrade(0)\n        setReviewLoad(0)\n        setReviewSpeech(0)\n    }\n\n    useEffect(() => {\n        resetReviewStates()\n    }, [lectureId])\n\n    useEffect(() => {\n        if (myReview) {\n            setReviewText(myReview.content)\n            setReviewGrade(myReview.grade)\n            setReviewLoad(myReview.load)\n            setReviewSpeech(myReview.speech)\n        } else {\n            resetReviewStates()\n        }\n    }, [myReview])\n\n    function submitReview() {\n        if (!canWriteReview) return\n        if (myReview) {\n            requestEditFunction({\n                content: reviewText,\n                grade: reviewGrade,\n                load: reviewLoad,\n                speech: reviewSpeech,\n            })\n            trackEvent(\"Edit Review\", {\n                reviewId: myReview.id,\n                lectureId,\n                courseName: name,\n                grade: reviewGrade,\n                load: reviewLoad,\n                speech: reviewSpeech,\n            })\n        } else {\n            requestCreateFunction({\n                lectureId: lectureId,\n                content: reviewText,\n                grade: reviewGrade,\n                load: reviewLoad,\n                speech: reviewSpeech,\n            })\n            trackEvent(\"Submit Review\", {\n                lectureId,\n                courseName: name,\n                grade: reviewGrade,\n                load: reviewLoad,\n                speech: reviewSpeech,\n            })\n        }\n    }\n\n    return (\n        <ReviewWrapper direction=\"column\" gap={0}>\n            {!canWriteReview && (\n                <DisabledMessage type=\"BigBold\" color=\"Text.default\">\n                    {t(\"common.review.notOpenYet\")}\n                </DisabledMessage>\n            )}\n            <DisabledOverlay\n                blur={!canWriteReview}\n                direction=\"column\"\n                gap={8}\n                align=\"stretch\"\n            >\n                <FlexWrapper direction=\"row\" gap={6} align={\"center\"}>\n                    <Typography type={\"NormalBold\"} color={\"Text.default\"}>\n                        {name}\n                    </Typography>\n                    {[\n                        professorName(professors),\n                        year,\n                        semesterToString(semester || SemesterEnum.SPRING),\n                    ].map((text, idx) => {\n                        return (\n                            <Typography type={\"Normal\"} color={\"Text.lighter\"} key={idx}>\n                                {text}\n                            </Typography>\n                        )\n                    })}\n                </FlexWrapper>\n                <ReviewBoxWrapper\n                    direction=\"column\"\n                    gap={0}\n                    justify=\"stretch\"\n                    align=\"stretch\"\n                >\n                    <TextInputArea\n                        placeholder={t(\"common.review.writingPlaceholder\")}\n                        value={reviewText}\n                        handleChange={setReviewText}\n                        area={true}\n                        disabled={!canWriteReview}\n                    />\n                </ReviewBoxWrapper>\n                <FlexWrapper\n                    direction=\"row\"\n                    gap={20}\n                    justify=\"space-between\"\n                    align=\"center\"\n                >\n                    <GradesWrapper direction=\"row\" gap={12} inert={!canWriteReview}>\n                        {(\n                            [\n                                [t(\"common.grade\"), reviewGrade, setReviewGrade],\n                                [t(\"common.load\"), reviewLoad, setReviewLoad],\n                                [t(\"common.speech\"), reviewSpeech, setReviewSpeech],\n                            ] as [\n                                string,\n                                ScoreEnum,\n                                Dispatch<SetStateAction<ScoreEnum>>,\n                            ][]\n                        ).map(([tag, currentState, DispatchFunction]) => (\n                            <FlexWrapper direction=\"row\" gap={6} align=\"center\" key={tag}>\n                                <Typography type=\"Normal\" color=\"Text.default\">\n                                    {tag}\n                                </Typography>\n                                <GradeWrap\n                                    score={currentState}\n                                    setScore={DispatchFunction}\n                                />\n                            </FlexWrapper>\n                        ))}\n                    </GradesWrapper>\n                    <Button\n                        type={\n                            reviewText && reviewGrade && reviewSpeech && reviewLoad\n                                ? \"selected\"\n                                : \"disabled\"\n                        }\n                        $paddingLeft={8}\n                        $paddingTop={8}\n                        onClick={submitReview}\n                    >\n                        <Typography type=\"Normal\">\n                            {myReview ? t(\"writeReviews.write.edit\") : t(\"common.upload\")}\n                        </Typography>\n                    </Button>\n                </FlexWrapper>\n            </DisabledOverlay>\n        </ReviewWrapper>\n    )\n}\n\nexport default ReviewWritingBlock\n"],"names":["ReviewWrapper","styled","FlexWrapper","theme","ReviewBoxWrapper","GradesWrapper","DisabledOverlay","props","DisabledMessage","Typography","ReviewWritingBlock","name","lectureId","professors","year","semester","t","useTranslation","user","status","useUserStore","queryClient","useQueryClient","myReview","setMyReview","useState","requestCreateFunction","useAPI","requestEditFunction","userReviewsQuery","semesterQuery","canWriteReview","useMemo","currentSemester","sem","useEffect","existingReview","review","reviewText","setReviewText","reviewGrade","setReviewGrade","reviewLoad","setReviewLoad","reviewSpeech","setReviewSpeech","resetReviewStates","submitReview","trackEvent","jsxs","jsx","professorName","semesterToString","SemesterEnum","text","idx","TextInputArea","tag","currentState","DispatchFunction","GradeWrap","Button"],"mappings":"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"}