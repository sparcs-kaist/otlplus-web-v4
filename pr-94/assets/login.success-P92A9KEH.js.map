{"version":3,"file":"login.success-P92A9KEH.js","sources":["../../../app/routes/login.success.tsx"],"sourcesContent":["import { useEffect, useRef } from \"react\"\n\nimport { useQueryClient } from \"@tanstack/react-query\"\nimport { useTranslation } from \"react-i18next\"\nimport { useNavigate } from \"react-router-dom\"\n\nimport { axiosClient } from \"@/libs/axios\"\nimport { identifyUser, trackEvent } from \"@/libs/mixpanel\"\nimport { clearQueryCache } from \"@/libs/offline\"\n\nexport default function LoginSuccessPage() {\n    const navigate = useNavigate()\n    const qc = useQueryClient()\n    const { i18n } = useTranslation()\n    const isMounted = useRef(true)\n\n    useEffect(() => {\n        isMounted.current = true\n\n        const handleLoginSuccess = async () => {\n            const hash = window.location.hash.substring(1)\n            const params = new URLSearchParams(hash)\n            const accessToken = params.get(\"accessToken\")\n            const refreshToken = params.get(\"refreshToken\")\n            const lang = i18n.resolvedLanguage || \"ko\"\n\n            if (accessToken && refreshToken) {\n                if (navigator.userAgent.includes(\"otl-app\")) {\n                    window.location.href = `org.sparcs.otl://login?accessToken=${accessToken}&refreshToken=${refreshToken}`\n                    return\n                }\n\n                await clearQueryCache()\n\n                qc.removeQueries({ queryKey: [\"/users/info\"] })\n                qc.removeQueries({ queryKey: [\"/timetables\"] })\n\n                await qc.prefetchQuery({\n                    queryKey: [\"/users/info\", null, lang],\n                    queryFn: async () => {\n                        const { data } = await axiosClient.get(\"/api/v2/users/info\", {\n                            headers: { \"Cache-Control\": \"no-cache\" },\n                        })\n                        return data\n                    },\n                })\n\n                const userInfo = qc.getQueryData<{\n                    id: number\n                    mail: string\n                    name?: string\n                    studentNumber?: number\n                    degree?: string\n                }>([\"/users/info\", null, lang])\n                if (userInfo) {\n                    identifyUser({\n                        id: userInfo.id,\n                        email: userInfo.mail,\n                        name: userInfo.name,\n                        studentNumber: userInfo.studentNumber,\n                        degree: userInfo.degree,\n                    })\n                    trackEvent(\"Sign In\", {\n                        user_id: userInfo.id,\n                        login_method: \"sso\",\n                        success: true,\n                    })\n                }\n\n                try {\n                    const { data: semesterData } = await axiosClient.get(\n                        \"/api/v2/semesters\",\n                        {\n                            headers: { \"Cache-Control\": \"no-cache\" },\n                        },\n                    )\n                    if (semesterData?.semesters?.length > 0) {\n                        const latestSemester =\n                            semesterData.semesters[semesterData.semesters.length - 1]\n                        if (latestSemester) {\n                            await qc.prefetchQuery({\n                                queryKey: [\n                                    \"/timetables/my-timetable\",\n                                    {\n                                        year: latestSemester.year,\n                                        semester: latestSemester.semester,\n                                    },\n                                    lang,\n                                ],\n                                queryFn: async () => {\n                                    const { data } = await axiosClient.get(\n                                        \"/api/v2/timetables/my-timetable\",\n                                        {\n                                            params: {\n                                                year: latestSemester.year,\n                                                semester: latestSemester.semester,\n                                            },\n                                            headers: { \"Cache-Control\": \"no-cache\" },\n                                        },\n                                    )\n                                    return data\n                                },\n                            })\n                        }\n                    }\n                } catch (error) {\n                    console.error(\"Failed to prefetch timetable:\", error)\n                }\n\n                if (isMounted.current) {\n                    navigate(\"/\", { replace: true })\n                }\n            } else if (isMounted.current) {\n                navigate(\"/\", { replace: true })\n            }\n        }\n\n        handleLoginSuccess()\n\n        return () => {\n            isMounted.current = false\n        }\n    }, [navigate, qc, i18n.resolvedLanguage])\n\n    return null\n}\n"],"names":["login_success","_UNSAFE_withComponentProps","navigate","useNavigate","qc","useQueryClient","i18n","useTranslation","isMounted","useRef","useEffect","current","hash","window","location","substring","params","URLSearchParams","accessToken","get","refreshToken","lang","resolvedLanguage","navigator","userAgent","includes","href","clearQueryCache","removeQueries","queryKey","prefetchQuery","queryFn","data","axiosClient","headers","userInfo","getQueryData","identifyUser","id","email","mail","name","studentNumber","degree","trackEvent","user_id","login_method","success","semesterData","semesters","length","latestSemester","year","semester","error","console","replace"],"mappings":"wRAUA,MAAAA,EAAAC,EAAA,UAA2C,CACvC,MAAMC,EAAWC,EAAA,EACXC,EAAKC,EAAA,EACL,CAAEC,KAAAA,GAASC,EAAA,EACXC,EAAYC,EAAAA,OAAO,EAAI,EAE7BC,OAAAA,EAAAA,UAAU,KACNF,EAAUG,QAAU,IAEO,SAAY,CACnC,MAAMC,EAAOC,OAAOC,SAASF,KAAKG,UAAU,CAAC,EACvCC,EAAS,IAAIC,gBAAgBL,CAAI,EACjCM,EAAcF,EAAOG,IAAI,aAAa,EACtCC,EAAeJ,EAAOG,IAAI,cAAc,EACxCE,EAAOf,EAAKgB,kBAAoB,KAEtC,GAAIJ,GAAeE,EAAc,CAC7B,GAAIG,UAAUC,UAAUC,SAAS,SAAS,EAAG,CACzCZ,OAAOC,SAASY,KAAO,sCAAsCR,CAAW,iBAAiBE,CAAY,GACrG,MACJ,CAEA,MAAMO,EAAA,EAENvB,EAAGwB,cAAc,CAAEC,SAAU,CAAC,aAAa,CAAE,CAAC,EAC9CzB,EAAGwB,cAAc,CAAEC,SAAU,CAAC,aAAa,CAAE,CAAC,EAE9C,MAAMzB,EAAG0B,cAAc,CACnBD,SAAU,CAAC,cAAe,KAAMR,CAAI,EACpCU,QAAS,SAAY,CACjB,KAAM,CAAEC,KAAAA,CAAK,EAAI,MAAMC,EAAYd,IAAI,qBAAsB,CACzDe,QAAS,CAAE,gBAAiB,UAAW,CAC3C,CAAC,EACD,OAAOF,CACX,CACJ,CAAC,EAED,MAAMG,EAAW/B,EAAGgC,aAMjB,CAAC,cAAe,KAAMf,CAAI,CAAC,EAC1Bc,IACAE,EAAa,CACTC,GAAIH,EAASG,GACbC,MAAOJ,EAASK,KAChBC,KAAMN,EAASM,KACfC,cAAeP,EAASO,cACxBC,OAAQR,EAASQ,MACrB,CAAC,EACDC,EAAW,UAAW,CAClBC,QAASV,EAASG,GAClBQ,aAAc,MACdC,QAAS,EACb,CAAC,GAGL,GAAI,CACA,KAAM,CAAEf,KAAMgB,CAAa,EAAI,MAAMf,EAAYd,IAC7C,oBACA,CACIe,QAAS,CAAE,gBAAiB,UAAW,CAC3C,CACJ,EACA,GAAIc,GAAcC,WAAWC,OAAS,EAAG,CACrC,MAAMC,EACFH,EAAaC,UAAUD,EAAaC,UAAUC,OAAS,CAAC,EACxDC,GACA,MAAM/C,EAAG0B,cAAc,CACnBD,SAAU,CACN,2BACA,CACIuB,KAAMD,EAAeC,KACrBC,SAAUF,EAAeE,UAE7BhC,CAAA,EAEJU,QAAS,SAAY,CACjB,KAAM,CAAEC,KAAAA,CAAK,EAAI,MAAMC,EAAYd,IAC/B,kCACA,CACIH,OAAQ,CACJoC,KAAMD,EAAeC,KACrBC,SAAUF,EAAeE,UAE7BnB,QAAS,CAAE,gBAAiB,UAAW,CAC3C,CACJ,EACA,OAAOF,CACX,CACJ,CAAC,CAET,CACJ,OAASsB,EAAO,CACZC,QAAQD,MAAM,gCAAiCA,CAAK,CACxD,CAEI9C,EAAUG,SACVT,EAAS,IAAK,CAAEsD,QAAS,EAAK,CAAC,CAEvC,MAAWhD,EAAUG,SACjBT,EAAS,IAAK,CAAEsD,QAAS,EAAK,CAAC,CAEvC,GAEA,EAEO,IAAM,CACThD,EAAUG,QAAU,EACxB,GACD,CAACT,EAAUE,EAAIE,EAAKgB,gBAAgB,CAAC,EAEjC,IACX,CAAA"}