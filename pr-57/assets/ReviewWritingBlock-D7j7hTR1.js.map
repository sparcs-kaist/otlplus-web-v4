{"version":3,"file":"ReviewWritingBlock-D7j7hTR1.js","sources":["../../../app/common/components/reviews/ReviewWritingBlock.tsx"],"sourcesContent":["import { type Dispatch, type SetStateAction, useEffect, useState } from \"react\"\n\nimport styled from \"@emotion/styled\"\nimport { useQueryClient } from \"@tanstack/react-query\"\nimport { useTranslation } from \"react-i18next\"\n\nimport Button from \"@/common/components/Button\"\nimport GradeWrap from \"@/common/components/GradeWrap\"\nimport { ScoreEnum } from \"@/common/enum/scoreEnum\"\nimport { SemesterEnum, semesterToString } from \"@/common/enum/semesterEnum\"\nimport FlexWrapper from \"@/common/primitives/FlexWrapper\"\nimport TextInputArea from \"@/common/primitives/TextInputArea\"\nimport Typography from \"@/common/primitives/Typography\"\nimport type { Professor } from \"@/common/schemas/professor\"\nimport type { Review } from \"@/common/schemas/review\"\nimport { useAPI } from \"@/utils/api/useAPI\"\nimport professorName from \"@/utils/professorName\"\nimport useUserStore from \"@/utils/zustand/useUserStore\"\n\nconst ReviewWrapper = styled(FlexWrapper)`\n    padding: 8px 10px;\n    width: 100%;\n    border-radius: 6px;\n    border: 1px ${({ theme }) => theme.colors.Background.Block.dark} solid;\n    background-color: ${({ theme }) => theme.colors.Background.Block.default};\n`\n\nconst ReviewBoxWrapper = styled(FlexWrapper)`\n    height: 160px;\n`\n\nconst GradesWrapper = styled(FlexWrapper)`\n    flex-wrap: wrap;\n`\n\nexport interface ReviewWritingBlockProps {\n    name: string\n    lectureId: number\n    professors: Professor[]\n    year: number\n    semester: SemesterEnum\n}\n\nfunction ReviewWritingBlock({\n    name,\n    lectureId,\n    professors,\n    year,\n    semester,\n}: ReviewWritingBlockProps) {\n    const { t } = useTranslation()\n    const { user, status } = useUserStore()\n    const queryClient = useQueryClient()\n\n    const [myReview, setMyReview] = useState<Review | null>(null)\n\n    const { requestFunction: requestCreateFunction } = useAPI(\"POST\", \"/reviews\", {\n        onSuccess: () => {\n            queryClient.invalidateQueries({ queryKey: [\"/reviews\"] })\n            queryClient.invalidateQueries({\n                queryKey: [`/users/${user?.id}/lectures`],\n            })\n            queryClient.invalidateQueries({\n                queryKey: [\"/users/written-reviews\"],\n            })\n        },\n    })\n\n    const { requestFunction: requestEditFunction } = useAPI(\n        \"PUT\",\n        `/reviews/${myReview?.id}`,\n        {\n            onSuccess: () => {\n                queryClient.invalidateQueries({\n                    queryKey: [\"/reviews\"],\n                })\n                queryClient.invalidateQueries({\n                    queryKey: [`/users/${user?.id}/lectures`],\n                })\n                queryClient.invalidateQueries({\n                    queryKey: [\"/users/written-reviews\"],\n                })\n            },\n        },\n    )\n\n    const { query: userReviewsQuery } = useAPI(\"GET\", `/users/written-reviews`, {\n        enabled: status === \"success\",\n    })\n\n    useEffect(() => {\n        if (userReviewsQuery.data) {\n            const existingReview = userReviewsQuery.data.reviews.find(\n                (review) => review.lectureId === lectureId,\n            )\n            if (existingReview) {\n                setMyReview(existingReview)\n            } else {\n                setMyReview(null)\n            }\n        }\n    }, [userReviewsQuery.data, lectureId])\n\n    const [reviewText, setReviewText] = useState<string>(\"\")\n\n    const [reviewGrade, setReviewGrade] = useState<ScoreEnum>(0)\n    const [reviewLoad, setReviewLoad] = useState<ScoreEnum>(0)\n    const [reviewSpeech, setReviewSpeech] = useState<ScoreEnum>(0)\n\n    function resetReviewStates() {\n        setReviewText(\"\")\n        setReviewGrade(0)\n        setReviewLoad(0)\n        setReviewSpeech(0)\n    }\n\n    useEffect(() => {\n        resetReviewStates()\n    }, [lectureId])\n\n    useEffect(() => {\n        if (myReview) {\n            setReviewText(myReview.content)\n            setReviewGrade(myReview.grade)\n            setReviewLoad(myReview.load)\n            setReviewSpeech(myReview.speech)\n        } else {\n            resetReviewStates()\n        }\n    }, [myReview])\n\n    function submitReview() {\n        if (myReview) {\n            requestEditFunction({\n                content: reviewText,\n                grade: reviewGrade,\n                load: reviewLoad,\n                speech: reviewSpeech,\n            })\n        } else {\n            requestCreateFunction({\n                lectureId: lectureId,\n                content: reviewText,\n                grade: reviewGrade,\n                load: reviewLoad,\n                speech: reviewSpeech,\n            })\n        }\n    }\n\n    return (\n        <ReviewWrapper direction=\"column\" gap={8} align=\"stretch\">\n            <FlexWrapper direction=\"row\" gap={6} align={\"center\"}>\n                <Typography type={\"NormalBold\"} color={\"Text.default\"}>\n                    {name}\n                </Typography>\n                {[\n                    professorName(professors),\n                    year,\n                    semesterToString(semester || SemesterEnum.SPRING),\n                ].map((text, idx) => {\n                    return (\n                        <Typography type={\"Normal\"} color={\"Text.lighter\"} key={idx}>\n                            {text}\n                        </Typography>\n                    )\n                })}\n            </FlexWrapper>\n            <ReviewBoxWrapper\n                direction=\"column\"\n                gap={0}\n                justify=\"stretch\"\n                align=\"stretch\"\n            >\n                <TextInputArea\n                    placeholder={t(\"common.review.writingPlaceholder\")}\n                    value={reviewText}\n                    handleChange={setReviewText}\n                    area={true}\n                />\n            </ReviewBoxWrapper>\n            <FlexWrapper direction=\"row\" gap={20} justify=\"space-between\" align=\"center\">\n                <GradesWrapper direction=\"row\" gap={12}>\n                    {(\n                        [\n                            [t(\"common.grade\"), reviewGrade, setReviewGrade],\n                            [t(\"common.load\"), reviewLoad, setReviewLoad],\n                            [t(\"common.speech\"), reviewSpeech, setReviewSpeech],\n                        ] as [string, ScoreEnum, Dispatch<SetStateAction<ScoreEnum>>][]\n                    ).map(([tag, currentState, DispatchFunction]) => (\n                        <FlexWrapper direction=\"row\" gap={6} align=\"center\" key={tag}>\n                            <Typography type=\"Normal\" color=\"Text.default\">\n                                {tag}\n                            </Typography>\n                            <GradeWrap score={currentState} setScore={DispatchFunction} />\n                        </FlexWrapper>\n                    ))}\n                </GradesWrapper>\n                <Button\n                    type={\n                        reviewText && reviewGrade && reviewSpeech && reviewLoad\n                            ? \"selected\"\n                            : \"disabled\"\n                    }\n                    $paddingLeft={8}\n                    $paddingTop={8}\n                    onClick={submitReview}\n                >\n                    <Typography type=\"Normal\">\n                        {myReview ? t(\"writeReviews.write.edit\") : t(\"common.upload\")}\n                    </Typography>\n                </Button>\n            </FlexWrapper>\n        </ReviewWrapper>\n    )\n}\n\nexport default ReviewWritingBlock\n"],"names":["ReviewWrapper","styled","FlexWrapper","theme","ReviewBoxWrapper","GradesWrapper","ReviewWritingBlock","name","lectureId","professors","year","semester","t","useTranslation","user","status","useUserStore","queryClient","useQueryClient","myReview","setMyReview","useState","requestCreateFunction","useAPI","requestEditFunction","userReviewsQuery","useEffect","existingReview","review","reviewText","setReviewText","reviewGrade","setReviewGrade","reviewLoad","setReviewLoad","reviewSpeech","setReviewSpeech","resetReviewStates","submitReview","jsxs","jsx","Typography","professorName","semesterToString","SemesterEnum","text","idx","TextInputArea","tag","currentState","DispatchFunction","GradeWrap","Button"],"mappings":"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"}