name: Deploy to CloudFront

on:
    workflow_dispatch:
        inputs:
            tag_name:
                description: "ë°°í¬í•  íƒœê·¸ ì´ë¦„ (ì˜ˆ: v1.0.0)"
                required: true
                type: string
            environment:
                description: "ë°°í¬ í™˜ê²½"
                required: true
                type: choice
                options:
                    - production
                    - dev
                default: production

env:
    AWS_REGION: ap-northeast-2
    S3_BUCKET_PROD: otl.sparcs.org-1
    S3_BUCKET_DEV: otl-plus-dev
    CLOUDFRONT_DIST_ID_PROD: E20OSZOEZVN51O

jobs:
    update-cloudfront:
        name: Update CloudFront Origin Path
        runs-on: ubuntu-latest
        permissions:
            contents: read

        steps:
            - name: Notify Slack - Deploy Started
              id: slack-start
              continue-on-error: true
              uses: slackapi/slack-github-action@v2.1.0
              with:
                  method: chat.postMessage
                  token: ${{ secrets.SLACK_BOT_TOKEN }}
                  payload: |
                      channel: ${{ secrets.SLACK_CHANNEL_ID }}
                      text: "ğŸš€ *OTL+ CloudFront ë°°í¬ ì‹œì‘*"
                      blocks:
                        - type: section
                          text:
                            type: mrkdwn
                            text: "ğŸš€ *OTL+ CloudFront ë°°í¬ ì‹œì‘*"
                        - type: section
                          fields:
                            - type: mrkdwn
                              text: "*Environment:*\n${{ inputs.environment }}"
                            - type: mrkdwn
                              text: "*Tag:*\n`${{ inputs.tag_name }}`"
                            - type: mrkdwn
                              text: "*Triggered by:*\n${{ github.actor }}"
                            - type: mrkdwn
                              text: "*Type:*\nManual Dispatch"
                        - type: context
                          elements:
                            - type: mrkdwn
                              text: "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"

            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Set environment variables
              id: set-env
              run: |
                  if [ "${{ inputs.environment }}" = "production" ]; then
                    echo "s3_bucket=${{ env.S3_BUCKET_PROD }}" >> $GITHUB_OUTPUT
                    echo "cloudfront_dist_id=${{ env.CLOUDFRONT_DIST_ID_PROD }}" >> $GITHUB_OUTPUT
                  else
                    echo "s3_bucket=${{ env.S3_BUCKET_DEV }}" >> $GITHUB_OUTPUT
                    echo "cloudfront_dist_id=${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_DEV }}" >> $GITHUB_OUTPUT
                  fi

            - name: Verify S3 version exists
              run: |
                  TAG_PATH="${{ inputs.tag_name }}"
                  S3_BUCKET="${{ steps.set-env.outputs.s3_bucket }}"

                  echo "ğŸ“¦ S3 ë²„í‚·ì—ì„œ ë²„ì „ í™•ì¸ ì¤‘: s3://$S3_BUCKET/$TAG_PATH/"

                  # S3ì— í•´ë‹¹ ê²½ë¡œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                  if aws s3 ls "s3://$S3_BUCKET/$TAG_PATH/" --recursive | head -n 1; then
                    echo "âœ… ë²„ì „ $TAG_PATH ê°€ S3ì— ì¡´ì¬í•©ë‹ˆë‹¤."
                  else
                    echo "âŒ ì˜¤ë¥˜: ë²„ì „ $TAG_PATH ê°€ S3 ë²„í‚·ì— ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!"
                    echo "ë°°í¬ ê°€ëŠ¥í•œ ë²„ì „ ëª©ë¡:"
                    aws s3 ls "s3://$S3_BUCKET/" | grep "PRE" || echo "ë²„ì „ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                    exit 1
                  fi

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install boto3
              run: pip install boto3

            - name: Update CloudFront Origin Path
              env:
                  CLOUDFRONT_DIST_ID: ${{ steps.set-env.outputs.cloudfront_dist_id }}
                  S3_BUCKET: ${{ steps.set-env.outputs.s3_bucket }}
                  TAG_NAME: ${{ inputs.tag_name }}
              run: |
                  python - <<'EOF'
                  import boto3
                  import os
                  import json
                  import time

                  cloudfront = boto3.client('cloudfront', region_name=os.environ['AWS_REGION'])
                  dist_id = os.environ['CLOUDFRONT_DIST_ID']
                  s3_bucket = os.environ['S3_BUCKET']
                  tag_name = os.environ['TAG_NAME']
                  new_origin_path = f"/{tag_name}"

                  print(f"ğŸ” CloudFront Distribution {dist_id} ì„¤ì • ê°€ì ¸ì˜¤ëŠ” ì¤‘...")

                  # í˜„ì¬ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
                  response = cloudfront.get_distribution_config(Id=dist_id)
                  config = response['DistributionConfig']
                  etag = response['ETag']

                  # S3 Origin ì°¾ê¸° ë° ì—…ë°ì´íŠ¸
                  updated = False
                  for origin in config['Origins']['Items']:
                      if s3_bucket in origin.get('Id', '') or s3_bucket in origin.get('DomainName', ''):
                          current_path = origin.get('OriginPath', '')
                          print(f"ğŸ“ í˜„ì¬ Origin Path: {current_path}")
                          print(f"ğŸ¯ ìƒˆë¡œìš´ Origin Path: {new_origin_path}")
                          
                          origin['OriginPath'] = new_origin_path
                          updated = True
                          target_origin_id = origin['Id']
                          break

                  if not updated:
                      print(f"âŒ S3 ë²„í‚· '{s3_bucket}'ì— í•´ë‹¹í•˜ëŠ” Originì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                      print("í˜„ì¬ ì„¤ì •ëœ Origins:")
                      for origin in config['Origins']['Items']:
                          print(f"  - ID: {origin['Id']}, Domain: {origin['DomainName']}")
                      exit(1)

                  # CloudFront ì„¤ì • ì—…ë°ì´íŠ¸
                  print(f"ğŸš€ CloudFront Distribution ì—…ë°ì´íŠ¸ ì¤‘...")
                  update_response = cloudfront.update_distribution(
                      Id=dist_id,
                      DistributionConfig=config,
                      IfMatch=etag
                  )

                  print(f"âœ… CloudFront Origin Pathê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!")
                  print(f"   Origin ID: {target_origin_id}")
                  print(f"   New Path: {new_origin_path}")
                  print(f"   Status: {update_response['Distribution']['Status']}")

                  EOF

            - name: Invalidate CloudFront cache
              env:
                  CLOUDFRONT_DIST_ID: ${{ steps.set-env.outputs.cloudfront_dist_id }}
                  TAG_NAME: ${{ inputs.tag_name }}
              run: |
                  echo "ğŸ—‘ï¸ CloudFront ìºì‹œ ë¬´íš¨í™” ì¤‘..."

                  INVALIDATION_ID=$(aws cloudfront create-invalidation \
                    --distribution-id $CLOUDFRONT_DIST_ID \
                    --paths "/*" \
                    --query 'Invalidation.Id' \
                    --output text)

                  echo "âœ… ìºì‹œ ë¬´íš¨í™” ìš”ì²­ ì™„ë£Œ!"
                  echo "   Invalidation ID: $INVALIDATION_ID"
                  echo "   Distribution ID: $CLOUDFRONT_DIST_ID"
                  echo ""
                  echo "â³ CloudFront ì „íŒŒëŠ” ëª‡ ë¶„ ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
                  echo ""
                  echo "ğŸ”— CloudFront ì½˜ì†”: https://console.aws.amazon.com/cloudfront/v3/home?region=us-east-1#/distributions/$CLOUDFRONT_DIST_ID"

            - name: Deployment Summary
              run: |
                  echo "## ğŸ‰ ë°°í¬ ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### ë°°í¬ ì •ë³´" >> $GITHUB_STEP_SUMMARY
                  echo "- **í™˜ê²½**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **íƒœê·¸**: \`${{ inputs.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "- **S3 ë²„í‚·**: \`${{ steps.set-env.outputs.s3_bucket }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "- **CloudFront Distribution**: \`${{ steps.set-env.outputs.cloudfront_dist_id }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "- **Origin Path**: \`/${{ inputs.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### ë‹¤ìŒ ë‹¨ê³„" >> $GITHUB_STEP_SUMMARY
                  echo "CloudFront ì „íŒŒê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ëª‡ ë¶„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”. ë°°í¬ ìƒíƒœëŠ” [CloudFront ì½˜ì†”](https://console.aws.amazon.com/cloudfront/v3/home?region=us-east-1#/distributions/${{ steps.set-env.outputs.cloudfront_dist_id }})ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY

            - name: Notify Slack - Deploy Success
              if: success()
              continue-on-error: true
              uses: slackapi/slack-github-action@v2.1.0
              with:
                  method: chat.postMessage
                  token: ${{ secrets.SLACK_BOT_TOKEN }}
                  payload: |
                      channel: ${{ secrets.SLACK_CHANNEL_ID }}
                      thread_ts: "${{ fromJson(steps.slack-start.outputs.response).ts }}"
                      text: "âœ… *OTL+ CloudFront ë°°í¬ ì™„ë£Œ*"
                      blocks:
                        - type: section
                          text:
                            type: mrkdwn
                            text: "âœ… *ë°°í¬ ì™„ë£Œ* - ì„±ê³µ ğŸ‰"
                        - type: section
                          fields:
                            - type: mrkdwn
                              text: "*Tag:*\n`${{ inputs.tag_name }}`"
                            - type: mrkdwn
                              text: "*Environment:*\n${{ inputs.environment }}"
                        - type: context
                          elements:
                            - type: mrkdwn
                              text: "<${{ inputs.environment == 'production' && 'https://otl.sparcs.org' || 'https://otl.dev.sparcs.org' }}|View Site> | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"

            - name: Notify Slack - Deploy Failed
              if: failure()
              continue-on-error: true
              uses: slackapi/slack-github-action@v2.1.0
              with:
                  method: chat.postMessage
                  token: ${{ secrets.SLACK_BOT_TOKEN }}
                  payload: |
                      channel: ${{ secrets.SLACK_CHANNEL_ID }}
                      thread_ts: "${{ fromJson(steps.slack-start.outputs.response).ts }}"
                      text: "âŒ *OTL+ CloudFront ë°°í¬ ì‹¤íŒ¨*"
                      blocks:
                        - type: section
                          text:
                            type: mrkdwn
                            text: "âŒ *ë°°í¬ ì‹¤íŒ¨* - ì‹¤íŒ¨ âš ï¸"
                        - type: section
                          fields:
                            - type: mrkdwn
                              text: "*Tag:*\n`${{ inputs.tag_name }}`"
                            - type: mrkdwn
                              text: "*Environment:*\n${{ inputs.environment }}"
                        - type: context
                          elements:
                            - type: mrkdwn
                              text: "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Logs>"
