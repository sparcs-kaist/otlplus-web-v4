name: CD

on:
    push:
        branches: [rc]
    release:
        types: [created]

env:
    NODE_VERSION: 20

jobs:
    deploy-dev:
        name: Deploy to Dev
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/rc' && github.event_name == 'push'
        permissions:
            contents: read
        steps:
            - name: Notify Slack - Deploy Started
              id: slack-start
              continue-on-error: true
              uses: slackapi/slack-github-action@v2.1.0
              with:
                  method: chat.postMessage
                  token: ${{ secrets.SLACK_BOT_TOKEN }}
                  payload: |
                      channel: ${{ secrets.SLACK_CHANNEL_ID }}
                      text: "üöÄ *OTL+ Dev Î∞∞Ìè¨ ÏãúÏûë*"
                      blocks:
                        - type: section
                          text:
                            type: mrkdwn
                            text: "üöÄ *OTL+ Dev Î∞∞Ìè¨ ÏãúÏûë*"
                        - type: section
                          fields:
                            - type: mrkdwn
                              text: "*Environment:*\nDev"
                            - type: mrkdwn
                              text: "*Branch:*\n`rc`"
                            - type: mrkdwn
                              text: "*Commit:*\n`${{ github.sha }}`"
                            - type: mrkdwn
                              text: "*Author:*\n${{ github.actor }}"
                        - type: context
                          elements:
                            - type: mrkdwn
                              text: "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"

            - uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10.7.1

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: pnpm

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build
              run: pnpm build
              env:
                  VITE_SENTRY_DSN: ${{ vars.SENTRY_DSN_DEV }}
                  SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
                  SENTRY_PROJECT: javascript-react
                  VITE_APP_API_URL: https://api.otl.dev.sparcs.org
                  VITE_APP_LOG_LEVEL: info
                  VITE_DEV_MODE: true
                  VITE_APP_DEV_API_AUTH_TOKEN: ${{ secrets.VITE_APP_DEV_API_AUTH_TOKEN }}
                  VITE_CHANNELTALK_PLUGIN_KEY: ${{ vars.CHANNELTALK_PLUGIN_KEY }}

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_DEV }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_DEV }}
                  aws-region: ap-northeast-2

            - name: Upload to S3 Dev
              run: |
                  aws s3 sync build/ s3://${{ vars.S3_BUCKET_DEV }}/ --delete
                  echo "‚úÖ Uploaded build files to S3 Dev: s3://${{ vars.S3_BUCKET_DEV }}/"

            - name: Invalidate CloudFront cache
              run: |
                  aws cloudfront create-invalidation \
                    --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_DEV }} \
                    --paths "/*"

            - name: Notify Slack - Deploy Success
              if: success()
              continue-on-error: true
              uses: slackapi/slack-github-action@v2.1.0
              with:
                  method: chat.postMessage
                  token: ${{ secrets.SLACK_BOT_TOKEN }}
                  payload: |
                      channel: ${{ secrets.SLACK_CHANNEL_ID }}
                      thread_ts: "${{ fromJson(steps.slack-start.outputs.response).ts }}"
                      text: "‚úÖ *OTL+ Dev Î∞∞Ìè¨ ÏôÑÎ£å*"
                      blocks:
                        - type: section
                          text:
                            type: mrkdwn
                            text: "‚úÖ *Î∞∞Ìè¨ ÏôÑÎ£å* - ÏÑ±Í≥µ üéâ"
                        - type: section
                          fields:
                            - type: mrkdwn
                              text: "*Commit:*\n`${{ github.sha }}`"
                            - type: mrkdwn
                              text: "*Duration:*\n${{ github.run_id }}"
                        - type: context
                          elements:
                            - type: mrkdwn
                              text: "<https://otl.dev.sparcs.org|View Site> | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"

            - name: Notify Slack - Deploy Failed
              if: failure()
              continue-on-error: true
              uses: slackapi/slack-github-action@v2.1.0
              with:
                  method: chat.postMessage
                  token: ${{ secrets.SLACK_BOT_TOKEN }}
                  payload: |
                      channel: ${{ secrets.SLACK_CHANNEL_ID }}
                      thread_ts: "${{ fromJson(steps.slack-start.outputs.response).ts }}"
                      text: "‚ùå *OTL+ Dev Î∞∞Ìè¨ Ïã§Ìå®*"
                      blocks:
                        - type: section
                          text:
                            type: mrkdwn
                            text: "‚ùå *Î∞∞Ìè¨ Ïã§Ìå®* - Ïã§Ìå® ‚ö†Ô∏è"
                        - type: section
                          fields:
                            - type: mrkdwn
                              text: "*Commit:*\n`${{ github.sha }}`"
                            - type: mrkdwn
                              text: "*Author:*\n${{ github.actor }}"
                        - type: context
                          elements:
                            - type: mrkdwn
                              text: "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Logs>"

    deploy-production:
        name: Deploy to Production
        runs-on: ubuntu-latest
        if: github.event_name == 'release'
        permissions:
            contents: write
        steps:
            - uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10.7.1

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: pnpm

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build
              run: pnpm build
              env:
                  VITE_SENTRY_DSN: ${{ vars.SENTRY_DSN_PROD }}
                  SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
                  SENTRY_PROJECT: otl-front-v4-prod
                  VITE_APP_API_URL: ${{ vars.API_URL_PROD }}
                  VITE_APP_LOG_LEVEL: info
                  VITE_DEV_MODE: false
                  VITE_CHANNELTALK_PLUGIN_KEY: ${{ vars.CHANNELTALK_PLUGIN_KEY }}

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
                  aws-region: ap-northeast-2

            - name: Upload to S3 Production
              run: |
                  aws s3 sync build/client/ s3://${{ vars.S3_BUCKET_PROD }}/${{ github.event.release.tag_name }}/ --delete
                  echo "‚úÖ Uploaded client build files to S3 Production: s3://${{ vars.S3_BUCKET_PROD }}/${{ github.event.release.tag_name }}/"

            - name: Create build archive
              run: |
                  cd build/client
                  tar -czf ../../build-${{ github.event.release.tag_name }}.tar.gz .
                  cd ../..

            - name: Upload release asset
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ github.event.release.upload_url }}
                  asset_path: ./build-${{ github.event.release.tag_name }}.tar.gz
                  asset_name: build-${{ github.event.release.tag_name }}.tar.gz
                  asset_content_type: application/gzip
