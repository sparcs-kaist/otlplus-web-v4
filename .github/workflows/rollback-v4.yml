name: Rollback V4 to Specific Version

on:
    workflow_dispatch:
        inputs:
            tag_name:
                description: "Î°§Î∞±Ìï† ÌÉúÍ∑∏ Ïù¥Î¶Ñ (Ïòà: v1.0.0)"
                required: true
                type: string

env:
    AWS_REGION: ap-northeast-2

jobs:
    rollback:
        name: Rollback V4 to ${{ inputs.tag_name }}
        runs-on: ubuntu-latest
        environment: production
        permissions:
            contents: read
            id-token: write

        steps:
            - uses: dopplerhq/secrets-fetch-action@v1.3.0
              id: doppler
              with:
                doppler-token: ${{ secrets.DOPPLER_TOKEN_PROD }}
                inject-env-vars: true
            - name: Notify Slack - Rollback Started
              id: slack-start
              continue-on-error: true
              uses: slackapi/slack-github-action@v2.1.0
              with:
                  method: chat.postMessage
                  token: ${{ steps.doppler.outputs.SLACK_BOT_TOKEN }}
                  payload: |
                      channel: ${{ steps.doppler.outputs.SLACK_CHANNEL_ID }}
                      text: "üîÑ *OTL+ V4 Î°§Î∞± ÏãúÏûë*"
                      blocks:
                        - type: section
                          text:
                            type: mrkdwn
                            text: "üîÑ *OTL+ V4 Î°§Î∞± ÏãúÏûë*"
                        - type: section
                          fields:
                            - type: mrkdwn
                              text: "*Environment:*\nProduction"
                            - type: mrkdwn
                              text: "*Target Tag:*\n`${{ inputs.tag_name }}`"
                            - type: mrkdwn
                              text: "*Triggered by:*\n${{ github.actor }}"
                        - type: context
                          elements:
                            - type: mrkdwn
                              text: "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ steps.doppler.outputs.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ steps.doppler.outputs.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Verify version exists in archive
              run: |
                  ARCHIVE_PATH="v4/${{ inputs.tag_name }}"
                  ARCHIVE_BUCKET="${{ steps.doppler.outputs.S3_BUCKET_ARCHIVE }}"

                  echo "üì¶ ÏïÑÏπ¥Ïù¥Î∏å Î≤ÑÌÇ∑ÏóêÏÑú Î≤ÑÏ†Ñ ÌôïÏù∏ Ï§ë: s3://$ARCHIVE_BUCKET/$ARCHIVE_PATH/"

                  if aws s3 ls "s3://$ARCHIVE_BUCKET/$ARCHIVE_PATH/" --recursive | head -n 1; then
                    echo "‚úÖ Î≤ÑÏ†Ñ ${{ inputs.tag_name }}Ïù¥(Í∞Ä) ÏïÑÏπ¥Ïù¥Î∏åÏóê Ï°¥Ïû¨Ìï©ÎãàÎã§."
                  else
                    echo "‚ùå Ïò§Î•ò: Î≤ÑÏ†Ñ ${{ inputs.tag_name }}Ïù¥(Í∞Ä) ÏïÑÏπ¥Ïù¥Î∏å Î≤ÑÌÇ∑Ïóê Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§!"
                    echo ""
                    echo "üìã ÏÇ¨Ïö© Í∞ÄÎä•Ìïú V4 Î≤ÑÏ†Ñ Î™©Î°ù:"
                    aws s3 ls "s3://$ARCHIVE_BUCKET/v4/" | grep "PRE" | awk '{print "  - " $2}' || echo "  Î≤ÑÏ†ÑÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§."
                    exit 1
                  fi

            - name: Copy from archive to live bucket
              run: |
                  ARCHIVE_BUCKET="${{ steps.doppler.outputs.S3_BUCKET_ARCHIVE }}"
                  LIVE_BUCKET="${{ steps.doppler.outputs.S3_BUCKET }}"
                  TAG="${{ inputs.tag_name }}"

                  echo "üîÑ Î°§Î∞± ÏßÑÌñâ Ï§ë..."
                  echo "   ÏÜåÏä§: s3://$ARCHIVE_BUCKET/v4/$TAG/"
                  echo "   ÎåÄÏÉÅ: s3://$LIVE_BUCKET/v4/"

                  aws s3 sync "s3://$ARCHIVE_BUCKET/v4/$TAG/" "s3://$LIVE_BUCKET/v4/" --delete

                  echo "‚úÖ Î°§Î∞± ÏôÑÎ£å: V4Í∞Ä $TAG Î≤ÑÏ†ÑÏúºÎ°ú Î≥µÏõêÎêòÏóàÏäµÎãàÎã§."

            - name: Invalidate CloudFront cache
              run: |
                  echo "üóëÔ∏è CloudFront Ï∫êÏãú Î¨¥Ìö®Ìôî Ï§ë..."

                  INVALIDATION_ID=$(aws cloudfront create-invalidation \
                    --distribution-id ${{ steps.doppler.outputs.CLOUDFRONT_DISTRIBUTION_ID }} \
                    --paths "/v4/*" \
                    --query 'Invalidation.Id' \
                    --output text)

                  echo "‚úÖ Ï∫êÏãú Î¨¥Ìö®Ìôî ÏöîÏ≤≠ ÏôÑÎ£å!"
                  echo "   Invalidation ID: $INVALIDATION_ID"
                  echo ""
                  echo "‚è≥ CloudFront Ï†ÑÌååÎäî Î™á Î∂Ñ Ï†ïÎèÑ ÏÜåÏöîÎê† Ïàò ÏûàÏäµÎãàÎã§."

            - name: Rollback Summary
              run: |
                  echo "## üîÑ V4 Î°§Î∞± ÏôÑÎ£å!" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Î°§Î∞± Ï†ïÎ≥¥" >> $GITHUB_STEP_SUMMARY
                  echo "- **ÌôòÍ≤Ω**: Production" >> $GITHUB_STEP_SUMMARY
                  echo "- **Î°§Î∞± Î≤ÑÏ†Ñ**: \`${{ inputs.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "- **ÏïÑÏπ¥Ïù¥Î∏å Î≤ÑÌÇ∑**: \`${{ steps.doppler.outputs.S3_BUCKET_ARCHIVE }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "- **ÎùºÏù¥Î∏å Î≤ÑÌÇ∑**: \`${{ steps.doppler.outputs.S3_BUCKET }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Îã§Ïùå Îã®Í≥Ñ" >> $GITHUB_STEP_SUMMARY
                  echo "CloudFront Ï†ÑÌååÍ∞Ä ÏôÑÎ£åÎê† ÎïåÍπåÏßÄ Î™á Î∂Ñ Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî." >> $GITHUB_STEP_SUMMARY

            - name: Notify Slack - Rollback Success
              if: success()
              continue-on-error: true
              uses: slackapi/slack-github-action@v2.1.0
              with:
                  method: chat.postMessage
                  token: ${{ steps.doppler.outputs.SLACK_BOT_TOKEN }}
                  payload: |
                      channel: ${{ steps.doppler.outputs.SLACK_CHANNEL_ID }}
                      thread_ts: "${{ fromJson(steps.slack-start.outputs.response).ts }}"
                      text: "‚úÖ *OTL+ V4 Î°§Î∞± ÏôÑÎ£å*"
                      blocks:
                        - type: section
                          text:
                            type: mrkdwn
                            text: "‚úÖ *Î°§Î∞± ÏôÑÎ£å* - ÏÑ±Í≥µ üéâ"
                        - type: section
                          fields:
                            - type: mrkdwn
                              text: "*Rolled back to:*\n`${{ inputs.tag_name }}`"
                            - type: mrkdwn
                              text: "*Environment:*\nProduction"
                        - type: context
                          elements:
                            - type: mrkdwn
                              text: "<https://otl.sparcs.org|View Site> | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"

            - name: Notify Slack - Rollback Failed
              if: failure()
              continue-on-error: true
              uses: slackapi/slack-github-action@v2.1.0
              with:
                  method: chat.postMessage
                  token: ${{ steps.doppler.outputs.SLACK_BOT_TOKEN }}
                  payload: |
                      channel: ${{ steps.doppler.outputs.SLACK_CHANNEL_ID }}
                      thread_ts: "${{ fromJson(steps.slack-start.outputs.response).ts }}"
                      text: "‚ùå *OTL+ V4 Î°§Î∞± Ïã§Ìå®*"
                      blocks:
                        - type: section
                          text:
                            type: mrkdwn
                            text: "‚ùå *Î°§Î∞± Ïã§Ìå®* - Ïã§Ìå® ‚ö†Ô∏è"
                        - type: section
                          fields:
                            - type: mrkdwn
                              text: "*Target Tag:*\n`${{ inputs.tag_name }}`"
                            - type: mrkdwn
                              text: "*Environment:*\nProduction"
                        - type: context
                          elements:
                            - type: mrkdwn
                              text: "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Logs>"
